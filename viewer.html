<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PLY Viewer (jsDelivr)</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #error {
      position: absolute;
      top: 1rem;
      left: 1rem;
      padding: 1rem;
      background: #f8d7da;
      color: #721c24;
      font-family: sans-serif;
    }
  </style>
</head>
<body>
  <script type="module">
    // =========================
    // 1) Import from jsDelivr
    // =========================
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js';
    import { PLYLoader } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/loaders/PLYLoader.js';

    // 2) Grab the 'ipfs' query param
    const params = new URLSearchParams(window.location.search);
    const ipfsUrl = params.get('ipfs');

    // 3) If missing URL, show error
    if (!ipfsUrl) {
      const errorDiv = document.createElement('div');
      errorDiv.id = "error";
      errorDiv.innerText = "Error: No IPFS URL provided. Add '?ipfs=...' to the URL.";
      document.body.appendChild(errorDiv);
      throw new Error("No IPFS URL provided in the query parameter.");
    }

    // 4) Basic Scene Setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, 
      window.innerWidth / window.innerHeight, 
      0.1, 
      1000
    );
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // 5) Lights
    const ambientLight = new THREE.AmbientLight(0x404040, 2);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(1, 1, 1);
    scene.add(directionalLight);

    // 6) Load the PLY via ipfsUrl
    const loader = new PLYLoader();
    loader.load(
      ipfsUrl,
      function (geometry) {
        geometry.computeVertexNormals();
        const material = new THREE.MeshStandardMaterial({ color: 0x0055ff });
        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        // Center camera on model
        geometry.computeBoundingBox();
        const bbox = geometry.boundingBox;
        const center = bbox.getCenter(new THREE.Vector3());
        camera.position.set(center.x, center.y, bbox.max.z * 3);
        camera.lookAt(center);
      },
      undefined,
      function (error) {
        console.error("Error loading PLY:", error);
        const errorDiv = document.createElement('div');
        errorDiv.id = "error";
        errorDiv.innerText = "Error loading PLY file. Check console.";
        document.body.appendChild(errorDiv);
      }
    );

    // 7) On window resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // 8) Animate
    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
